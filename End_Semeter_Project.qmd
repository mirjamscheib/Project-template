---
title: "Effects of environmental factors on spatio-temporal movement patterns of students"
subtitle: "Project for Patterns and Trends in Environmental Data - Computational Movement Analysis"
author: "Mirjam Scheib & Miriam Steinhauer"
date: "5/22/2021"
format:
  html:
    code-fold: true
    code-tools: true 
execute:
  echo: true
  message: false
  eval: true
  warning: false
  cache: true

---


# To Do's im Code
Map visualization schön mache (Mirj)
Boxplots vereinheitlichen (Mirj)
Captions für Plots/Bilder (figure 1, fig. 2 ect) (Miri)
Titel die den Code beschreiben in Code-Boxen nehmen (Miri)
Layout, rendern (Miri)

# BACKGROUND AND RESEARCH QUESTIONS 
It is known that several factors like the weather condition (Brum-Bastos et al., 2018; Guo et al., 2022), the day of the week and time of the day (Liu et al., 2020; Sathishkumar et al., 2020) influence spatio-temporal movement patterns of people. There are several study’s investigating movement patterns of people in urban areas with the aim to improve the distribution of facilities and the provisioning of transportation services, as well as to manage traffic peaks (Kyaing et al., 2017; Liu et al., 2020). Nevertheless, most studies do not focus on specific social groups (e.g. workforce, students, pensioners), that might follow distinct spatio-temporal patterns, showing a potential demand for a specific adaption of infrastructure. The canton of Zurich accommodates the most students in Switzerland, with numbers continuing to rise (Bundesamt für Statistik, 2023; Medienmitteilung Kanton ZH, 2021). Additionally, students and apprentices (from the age of  15 years) make up 39% of the public transport commuter mass, which is why knowledge of spatio-temporal patterns of students could help to manage train and other public transport infrastructure (Bundesamt für Statistik, 2021). Therefore, we want to investigate the influence of three environmental factors on spatio-temporal movement patterns of students, aiming to answer the following research questions:   

Does the day of the week (weekend vs. workday) have an influence on the spatio-temporal movement patterns of students?  

Does the time of the day have an influence on the spatio-temporal movement patterns of students?  

Does precipitation has an impact the spatio-temporal patterns of students?  

# DATA & METHODS
## Data sets

## Pre-processing
```{r}
### Packages ###
# clear space 
rm(list=ls())

# load packages 
library("readr")
library("dplyr")
library("ggplot2")
library("sf")
library("terra")
library("tmap")
library("gitcreds")
library("dplyr")
library("SimilarityMeasures")
library("lubridate")
library("plotly")
```

# RESULTS 
## 1| Impact of the day of the week 
Does the day of the week (weekend vs. workday) have an impact on spatio-temporal movement patterns?

```{r}
# load clean data 
posmo <- read_delim("posmo_data/posmo_trips.csv")
```


```{r}
### Spatial Analysis ###

#| label: Boxplot comparing trip distance between weekend and weekday of travelmodes
#| fig-cap: "Trip distance per transport mode comparing weekends and weekdays, the trip distance is logarythmised"

  ggplot() +
  geom_boxplot(data = posmo, aes(day_week, log(trip_dis), fill = day_week)) +
  labs(title = "Trip Distance per Transport Mode", subtitle = "Comparing Weekend vs. Weekday", fill = "Day of the Week") +
  ylab("Log Trip Distance [m]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("weekday" = "lavenderblush3", "weekend" = "aquamarine3"), labels = c( "Weekday", "Weekend")) +
    facet_wrap(~transport_mode, nrow = 1) +
    theme_minimal() +
  theme(axis.text.x=element_blank())

```

```{r}
#| label: Boxplot comparing trip speed between weekend and weekday of travelmodes
#| fig-cap: "Trip speed per transport mode comparing weekends and weekdays, the trip speed is logarythmised"

ggplot(posmo, aes(day_week, log(trip_speed), fill = day_week)) +
  geom_boxplot() +
  labs(title = "Speed per Transport Mode", subtitle = "Comparing Weekend vs. Weekday", fill = "Day of the Week") +
  ylab("Log Speed [m/s]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("weekday" = "lavenderblush3", "weekend" = "aquamarine3"), labels = c( "Weekday", "Weekend")) +
  facet_wrap(~transport_mode, nrow = 1) +
  theme_minimal() +
  theme(axis.text.x=element_blank())
```

```{r}
#| label: Table summary
question1_summary <- posmo |> 
  group_by(day_week, transport_mode) |> 
  summarise(steplength_mean = mean(steplength, na.rm = T),
            speed_mean = mean(speed, na.rm = T)) |> 
  mutate(percentage_steplength = steplength_mean/sum(steplength_mean)*100,
         percentage_speed = speed_mean/sum(speed_mean)*100)

question1_summary
```

```{r}
### Temporal Analysis ###

#| label: Boxplot comparing trip duration between weekend and weekday of travelmodes
#| fig_cap: "Trip duration per transport mode comparing weekends and weekdays, the trip duration is logarythmised"

ggplot() +
  geom_boxplot(data = posmo, aes(day_week, log(trip_duration/60), fill = day_week)) +
   labs(title = "Trip Duration per Transport Mode", subtitle = "Comparing Weekend vs. Weekday", fill = "Day of the Week") +
  ylab("Log Duration [min]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("weekday" = "lavenderblush3", "weekend" = "aquamarine3"), labels = c( "Weekday", "Weekend")) +
  facet_wrap(~transport_mode, nrow = 1) +
  theme_minimal() +
  theme(axis.text.x=element_blank())

```


```{r}
### Create Visual Maps  ###
#| label: transform posmo data into sf object

# transform posmo data into an sf object 
posmo <- st_as_sf(posmo, coords = c("X","Y"), crs = 2056) 

# 1. add grouping variable to the sf object
posmo_grouped <- group_by(posmo, dataset)

# 2. use summarise() to "dissolve" all point into a multipoint object
posmo_smry <- summarise(posmo_grouped)

# 3. run st_convex_hull()
mcp_posmo <- st_convex_hull(posmo_smry)
```

```{r}
#| label: visual map
#| fig-cap: "..."

# set visual mode
tmap_mode("view")

# segmented visualisation 
tm_shape(mcp_posmo) +
  tm_fill(col = "dataset", alpha = 0.4) +
  tm_legend(title = "User") +
  tm_shape(mcp_posmo) +
  tm_borders(col = "red") +
  tm_shape(posmo) +
  tm_dots(col = "day_week") 
```

## 2| Impact of the time of the day 
Does the time of the day have an influence on spatio-temporal movement patterns of students?

```{r}
#| label: load clean data

# load clean data 
posmo <- read_delim("posmo_data/posmo_trips.csv")

```

```{r}
### Spatial Analysis ###

#| label: dataframe with mean steplenght, speer per hour of all dates

# round datetime to 1h 
posmo_round <- posmo |>
  mutate(hour = lubridate::hour(datetime))

# create dataframe, which calculates mean steplength, speed per hour over all dates
# here with weekdays 
posmo_hour <- posmo_round |>
  group_by(hour, weekday) |>
  summarise(mean_dis = mean(trip_dis, na.rm = TRUE),
            mean_speed = mean(trip_speed, na.rm = TRUE), 
            mean_duration = mean(trip_duration, na.rm = TRUE)) 

# create dataframe, which calculates mean steplength, speed per hour over all dates
# here with days of the week (weekend vs. weekday)
posmo_day <- posmo_round |>
  group_by(hour, day_week)|>
  summarise(mean_dis = mean(trip_dis, na.rm = TRUE),
            mean_speed = mean(trip_speed, na.rm = TRUE),
            mean_duration = mean(trip_duration, na.rm = TRUE)) 

```


```{r}
#| label: visual map
#| fig-cap: "..."

# mo-so with distance (steplength) travelled
ggplot(posmo_hour, aes(hour, mean_dis, col = weekday)) +
  geom_point() +
   geom_line(lwd = 0.7) +
  labs(title = "Mean Tavelled Distance over 24h", subtitle = "Compared from Monday to Sunday", color = "Day of the Week") +
  ylab("Mean Distance [m]") +
  xlab("Hour") +
  theme_minimal()
```

```{r}
#| label: visual map
#| fig-cap: "..."

# mo-so with speed 
ggplot(posmo_hour, aes(hour, mean_speed, col = weekday)) +
  geom_point() +
  geom_line(lwd = 0.7) +
  labs(title = "Mean Speed over 24h", subtitle = "Compared from Monday to Sunday", color = "Day of the Week") +
  ylab("Mean Speed [m/s]") +
  xlab("Hour") +
  theme_minimal()
```

```{r}
#| label: visual map
#| fig-cap: "..."

# mo-so with trip duration  
ggplot(posmo_hour, aes(hour, mean_duration/60, col = weekday)) +
  geom_point() +
  geom_line(lwd = 0.7) +
  labs(title = "Mean Trip Duration over 24h", subtitle = "Compared from Monday to Sunday", color = "Day of the Week") +
  ylab("Mean Duration [min]") +
  xlab("Hour") +
  theme_minimal()
```



```{r}


# weekend vs. weekday with distance (steplength) travelled
ggplot(posmo_day, aes(hour, mean_dis, col = day_week)) +
  geom_point() +
  geom_line(lwd = 0.7) +
  labs(title = "Mean Tavelled Distance over 24h", subtitle = "Compared between Weekend vs. Weekday", color = "Weekend vs. Weekday") +
  ylab("Mean Distance [m]") +
  xlab("Hour") +
  theme_minimal()
```


```{r}
# weekend vs. weekday with speed
ggplot(posmo_day, aes(hour, mean_speed, col = day_week)) +
  geom_point() +
  geom_line(lwd = 0.7) +
  labs(title = "Mean Speed over 24h", subtitle = "Compared between Weekend vs. Weekday", color = "Weekend vs. Weekday") +
  ylab("Mean Speed [m/s]") +
  xlab("Hour") +
  theme_minimal()
```

```{r}

# weekend vs. weekday with trip duration 
ggplot(posmo_day, aes(hour, mean_duration/60, col = day_week)) +
  geom_point() +
    geom_line(lwd = 0.7) +
  labs(title = "Mean Trip Duration over 24h", subtitle = "Compared between Weekend vs. Weekday", color = "Weekend vs. Weekday") +
  ylab("Mean Duration [min]") +
  xlab("Hour") +
  scale_color_manual(values = c("weekday" = "lavenderblush3", "weekend" = "aquamarine3", labels = c("Weekday", "Weekend"))) +
  theme_minimal()
```


## 3| Impact of precipitataion
Does the weather condition (e.g. rain, no rain) impact spatio-temporal patterns of students on different travel modes?

### Spatial Analysis 
#### Load cleaned data 
```{r message=FALSE, warning=FALSE, eval = TRUE, echo = TRUE, fold = TRUE}
# load clean data 
posmo <- read_delim("posmo_data/posmo_trips.csv")
```

#### Speed & Distance 
```{r message=FALSE, warning=FALSE, eval = TRUE, echo = TRUE, fold = TRUE}
# Boxplot compare rain/ no rain without grouping (overall steplength)
ggplot(posmo, aes(transport_mode, log(steplength), fill = rain_day)) +
  geom_boxplot() +
  labs(title = "Travelled Distance per Transport Mode", subtitle = "Comparing Rainy vs. Dry Days", fill = "Rain vs. Dry") +
  ylab("Log Steplength [m]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("no_rain" = "lavenderblush3", "rain" = "aquamarine3"), labels = c( "Dry", "Rain")) +
  theme_minimal() +
  theme(axis.text.x=element_blank())


# Boxplot compare rain/ no rain without grouping (overall speed)
ggplot(posmo, aes(transport_mode, log(speed), fill = rain_day)) +
  geom_boxplot() +
   labs(title = "Speed per Transport Mode", subtitle = "Comparing days with/ without precipitation", fill = "precipitation") +
  ylab("Log Speed [m/s]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("no_rain" = "lavenderblush3", "rain" = "aquamarine3"), labels = c( "No", "Yes")) +
  theme_minimal() +
  theme(axis.text.x=element_blank())

# Table Summary 
question2_summary <- posmo |> 
  group_by(rain_day, transport_mode) |> 
  summarise(steplength_mean = mean(steplength, na.rm = T),
            speed_mean = mean(speed, na.rm = T)) |> 
  mutate(percentage_steplength = steplength_mean/sum(steplength_mean)*100,
         percentage_speed = speed_mean/sum(speed_mean)*100)
```

### Temporal Analysis 
#### Duration 
Mean duration of trips compared between Rain and Dry Days
```{r message=FALSE, warning=FALSE, eval = TRUE, echo = TRUE, fold = TRUE}
# Calculate mean duration and mean dis of trips per day
# mean trip duration looks odd, need to check that (!!)
ggplot() +
  geom_boxplot(data = posmo, aes(transport_mode, trip_duration/60, fill = rain_day)) +
  labs(title = "Travelled Distance per Transport Mode", subtitle = "Comparing Rainy vs. Dry Days", fill = "Rain vs. Dry") +
  ylab("Duration [min]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("no_rain" = "lavenderblush3", "rain" = "aquamarine3"), labels = c( "Dry", "Rain")) +
  theme_minimal() +
  theme(axis.text.x=element_blank())

# mean trip distance compared between rain/no rain
ggplot() +
  geom_boxplot(data = posmo, aes(transport_mode, log(trip_dis), fill = rain_day)) +
    labs(title = "Speed per Transport Mode", subtitle = "Comparing Rainy vs. Dry Days", fill = "Rain vs. Dry") +
  ylab("Log Distance [m]") +
  xlab("Transport Mode") +
  scale_fill_manual(values = c("no_rain" = "lavenderblush3", "rain" = "aquamarine3"), labels = c( "Dry", "Rain")) +
  theme_minimal() +
  theme(axis.text.x=element_blank())
```

### Legende anschreiben - Create Visual Maps 
```{r message=FALSE, warning=FALSE, eval = TRUE, echo = TRUE, fold = TRUE}
# transform posmo data into an sf object 
posmo <- st_as_sf(posmo, coords = c("X","Y"), crs = 2056) 


# 1. add grouping variable to the sf object
posmo_grouped <- group_by(posmo, dataset)

# 2. use summarise() to "dissolve" all point into a multipoint object
posmo_smry <- summarise(posmo_grouped)

# 3. run st_convex_hull()
mcp_posmo <- st_convex_hull(posmo_smry)
```

```{r message=FALSE, warning=FALSE, eval = TRUE, echo = TRUE, fold = TRUE}
tmap_mode("view")

# segmented visualisation 
tm_shape(mcp_posmo) +
  tm_fill(col = "dataset", alpha = 0.4) +
  tm_shape(mcp_posmo) +
  tm_borders(col = "red") +
  tm_shape(posmo) +
  tm_dots(col = "rain_day") 
```


#DISCUSSION 
TEXT 


# SOURCES

## Data
-> woher war regendatenset 

## Literature
- Brum-Bastos, V. S., Long, J. A., & Demšar, U. (2018). Weather effects on human mobility: A study using multi-channel sequence analysis. Computers, Environment and Urban Systems, 71, 131–152. https://doi.org/10.1016/j.compenvurbsys.2018.05.004

- Bundesamt für Statistik. (2021). Pendlermobilität. Bundesamt für Statistik. https://www.bfs.admin.ch/bfs/de/home/statistiken/mobilitaet-verkehr/personenverkehr/pendlermobilitaet.html

- Guo, P., Sun, Y., Chen, Q., Li, J., & Liu, Z. (2022). The Impact of Rainfall on Urban Human Mobility from Taxi GPS Data. Sustainability, 14(15), Article 15. https://doi.org/10.3390/su14159355
- Halsey, L. G. (2016). Terrestrial movement energetics: Current knowledge and its application to the optimising animal. Journal of Experimental Biology, 219(10), 1424–1431.

- Kyaing, K., Lwin, K., & Sekimoto, Y. (2017). Human mobility patterns for different regions in Myanmar based on CDRs data. IPTEK Journal of Proceedings Series, 3(6).

- Liu, X., Sun, L., Sun, Q., & Gao, G. (2020). Spatial Variation of Taxi Demand Using GPS Trajectories and POI Data. Journal of Advanced Transportation, 2020, e7621576.
https://doi.org/10.1155/2020/7621576

- Medienmitteilung KT ZH. (2021). Bildung in Zahlen. Kanton Zürich. https://www.zh.ch/de/news-uebersicht/medienmitteilungen/2021/07/bildung-in-zahlen.html

- Sathishkumar, Cho, Y., & Jangwoo, Park. (2020). Seoul bike trip duration prediction using data mining techniques. IET Intelligent Transport Systems, 14(11), 1465–1474. https://doi.org/10.1049/iet-its.2019.0796




